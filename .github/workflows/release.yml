name: Cloud Build
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Prepare build files
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          KEY_BASE64: ${{ secrets.KEY_BASE64 }}
          SIGNING_CONFIG: ${{ secrets.SIGNING_CONFIG }}
        run: |
          # google-services.json (use secret if provided, else dummy for CI)
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            printf '%s' "$GOOGLE_SERVICES_JSON" > app/google-services.json
          else
            printf '%s\n' '{"project_info":{"project_number":"000000000000","project_id":"rikkahub-ci","storage_bucket":"rikkahub-ci.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000","android_client_info":{"package_name":"me.rerere.rikkahub"}},"api_key":[{"current_key":"DUMMY_KEY"}]}],"configuration_version":"1"}' > app/google-services.json
            echo "::warning::GOOGLE_SERVICES_JSON not set; using dummy firebase config for CI build."
          fi

          # signing (release). Use secrets if provided, else generate a temp keystore.
          if [ -n "$KEY_BASE64" ] || [ -n "$SIGNING_CONFIG" ]; then
            if [ -z "$KEY_BASE64" ] || [ -z "$SIGNING_CONFIG" ]; then
              echo "::error::KEY_BASE64 and SIGNING_CONFIG must be set together."
              exit 1
            fi
            printf '%s' "$KEY_BASE64" | base64 -d > app/app.key
            STORE_PASSWORD=$(printf '%s' "$SIGNING_CONFIG" | sed -n 's/^storePassword=//p')
            KEY_ALIAS=$(printf '%s' "$SIGNING_CONFIG" | sed -n 's/^keyAlias=//p')
            KEY_PASSWORD=$(printf '%s' "$SIGNING_CONFIG" | sed -n 's/^keyPassword=//p')
            if [ -z "$STORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
              echo "::error::SIGNING_CONFIG must include storePassword, keyAlias, and keyPassword."
              exit 1
            fi
            printf '%s\n' \
              'storeFile=app.key' \
              "storePassword=$STORE_PASSWORD" \
              "keyAlias=$KEY_ALIAS" \
              "keyPassword=$KEY_PASSWORD" \
              > local.properties
          else
            echo "::warning::Release signing secrets not set; generating a temporary keystore for CI build."
            keytool -genkeypair -v \
              -keystore app/app.key \
              -storepass android \
              -keypass android \
              -alias androiddebugkey \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
            printf '%s\n' \
              'storeFile=app.key' \
              'storePassword=android' \
              'keyAlias=androiddebugkey' \
              'keyPassword=android' \
              > local.properties
          fi

      - name: Gradle Build
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: artifacts
          path: app/build/outputs/apk/release/*.apk
