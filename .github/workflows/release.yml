name: Cloud Build
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Prepare build files
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          KEY_BASE64: ${{ secrets.KEY_BASE64 }}
          SIGNING_CONFIG: ${{ secrets.SIGNING_CONFIG }}
        run: |
          # google-services.json (use secret if provided, else dummy for CI)
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            printf '%s' "$GOOGLE_SERVICES_JSON" > app/google-services.json
            python3 - <<'PY'
import copy
import json
from pathlib import Path

path = Path("app/google-services.json")
try:
    data = json.loads(path.read_text(encoding="utf-8"))
except Exception:
    raise SystemExit("Invalid GOOGLE_SERVICES_JSON")

clients = data.get("client") or []
if not isinstance(clients, list):
    clients = []

def package_name(client):
    return (
        client.get("client_info", {})
        .get("android_client_info", {})
        .get("package_name")
    )

names = {package_name(client) for client in clients}
if "me.rerere.rikkahub.debug" not in names:
    release_client = next(
        (client for client in clients if package_name(client) == "me.rerere.rikkahub"),
        clients[0] if clients else None,
    )
    if release_client is not None:
        debug_client = copy.deepcopy(release_client)
        debug_client.setdefault("client_info", {}).setdefault("android_client_info", {})[
            "package_name"
        ] = "me.rerere.rikkahub.debug"
        clients.append(debug_client)
        data["client"] = clients
        path.write_text(json.dumps(data), encoding="utf-8")
PY
          else
            printf '%s\n' '{"project_info":{"project_number":"000000000000","project_id":"rikkahub-ci","storage_bucket":"rikkahub-ci.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000","android_client_info":{"package_name":"me.rerere.rikkahub"}},"api_key":[{"current_key":"DUMMY_KEY"}]},{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000001","android_client_info":{"package_name":"me.rerere.rikkahub.debug"}},"api_key":[{"current_key":"DUMMY_KEY"}]}],"configuration_version":"1"}' > app/google-services.json
            echo "::warning::GOOGLE_SERVICES_JSON not set; using dummy firebase config for CI build."
          fi

          # signing (release). Use secrets if provided, else generate a temp keystore.
          if [ -n "$KEY_BASE64" ] || [ -n "$SIGNING_CONFIG" ]; then
            if [ -z "$KEY_BASE64" ] || [ -z "$SIGNING_CONFIG" ]; then
              echo "::error::KEY_BASE64 and SIGNING_CONFIG must be set together."
              exit 1
            fi
            printf '%s' "$KEY_BASE64" | base64 -d > app/app.key
            STORE_PASSWORD=$(printf '%s' "$SIGNING_CONFIG" | sed -n 's/^storePassword=//p')
            KEY_ALIAS=$(printf '%s' "$SIGNING_CONFIG" | sed -n 's/^keyAlias=//p')
            KEY_PASSWORD=$(printf '%s' "$SIGNING_CONFIG" | sed -n 's/^keyPassword=//p')
            if [ -z "$STORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
              echo "::error::SIGNING_CONFIG must include storePassword, keyAlias, and keyPassword."
              exit 1
            fi
            printf '%s\n' \
              'storeFile=app.key' \
              "storePassword=$STORE_PASSWORD" \
              "keyAlias=$KEY_ALIAS" \
              "keyPassword=$KEY_PASSWORD" \
              > local.properties
          else
            echo "::warning::Release signing secrets not set; generating a temporary keystore for CI build."
            keytool -genkeypair -v \
              -keystore app/app.key \
              -storepass android \
              -keypass android \
              -alias androiddebugkey \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
            printf '%s\n' \
              'storeFile=app.key' \
              'storePassword=android' \
              'keyAlias=androiddebugkey' \
              'keyPassword=android' \
              > local.properties
          fi

      - name: Gradle Build
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug assembleRelease

      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: artifacts-debug
          path: app/build/outputs/apk/debug/*.apk

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: artifacts-release
          path: app/build/outputs/apk/release/*.apk
